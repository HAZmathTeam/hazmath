#####################################################
# Modified 2012-07-21 --jha
# Modified 2015-01-10 --Xiaozhe 
####################################################

########################################################################
# Generic Directories
########################################################################
DIR0 = .
INCLUDE = -I$(DIR0)/include
CSRCDIR = $(DIR0)/src
LIB = $(DIR0)/lib/libHAZMAT.a
DRIVERS = $(DIR0)/drivers

########################################################################
# Machine Specific Compilers
########################################################################
CC = gcc
FC = gfortran
CXX = g++
CPP = g++
AR = ar ruc

########################################################################
# Depedencs 
########################################################################
# ARPACK
#ARPACKLIB = 

# UMFPACK
#XH 
#UMFPACKDIR = /usr/local
#lz
#UMFPACKDIR = /Users/ltz1/packages
#JA
UMFPACKDIR = /opt/local
UMFPACKINCLUDE = -I$(UMFPACKDIR)/include
UMFPACKLIB = -L$(UMFPACKDIR)/lib -lsuitesparseconfig -lcholmod -lamd -lcolamd -lccolamd -lcamd -lspqr -lumfpack -lamd -lcxsparse

# METIS
#METISDIR = /MFEM-SVN/metis-4.0
#METISINCLUDE = -I$(METISDIR)/include
#METISLIB = -L$(METISDIR) -lmetis

# BLAS
BLASLIB = -framework Accelerate

########################################################################
# Compiling Options
########################################################################
BOPT = -g -pg -O0 -Wall #-fopenmp

COPTS = $(BOPT)
CINCLUDES = $(INCLUDE) $(UMFPACKINCLUDE) $(METISINCLUDE)
CFLAGS = $(COPTS) $(CINCLUDES)

FOPTS = $(BOPT) -fno-second-underscore
FINCLUDES = $(CINCLUDES)
FFLAGS = $(FOPTS) $(FINCLUDES)

########################################################################
# Set Libraries 
########################################################################
# Include all Libraries including UMFPACK, its dependencies, BLAS, and LAPACK
LIBS = $(LIB) $(BLASLIB) $(UMFPACKLIB) $(ARPACKLIB) $(METISLIB) 

########################################################################
# Link options
########################################################################
LINKOPTS = $(BOPT)
CLFLAGS = -lstdc++ $(LINKOPTS) $(LIBS)
FLFLAGS = -lm $(LINKOPTS) $(LIBS)

########################################################################
# Rules for compiling the source files
########################################################################
.SUFFIXES: .c .cc .cpp
#
CSRC := $(wildcard $(CSRCDIR)/assemble/*.c) 
CSRC += $(wildcard $(CSRCDIR)/fem/*.c)
CSRC += $(wildcard $(CSRCDIR)/grid/*.c)
CSRC += $(wildcard $(CSRCDIR)/solver/*.c)
CSRC += $(wildcard $(CSRCDIR)/utilities/*.c)
#
OBJSC := $(patsubst %.c,%.o,$(CSRC))
#
.c.o:
	$(CC) -c $< -o $@ $(CFLAGS) 
	$(AR) $(LIB) $@
#
.cc.o:
	$(CPP) -c $< -o $@ $(CFLAGS) 
	$(AR) $(LIB) $@
#
.cpp.o:
	$(CPP) -c $< -o $@ $(CFLAGS) 
	$(AR) $(LIB) $@
#

########################################################################
# List of all programs to be compiled
########################################################################

# Everything
ALLPROG=$(LIB) test diff

########################################################################
# Link
########################################################################

all: $(ALLPROG)

Default: $(ALLPROG)	

headers: 
	/bin/cat $(CSRCDIR)/assemble/*.c $(CSRCDIR)/fem/*.c \
	 $(CSRCDIR)/grid/*.c $(CSRCDIR)/solver/*.c  $(CSRCDIR)/utilities/*.c \
	| awk -v name="hazmat.h" -f mkheaders.awk > ./include/hazmat.h

$(LIB): $(OBJSC)
	ranlib $(LIB)

lib: $(OBJSC)
	ranlib $(LIB)

########################################################################
# Some test problems
########################################################################

test: $(LIB)
	$(CC) $(CFLAGS) -c $(DRIVERS)/test.c -o $(DRIVERS)/test.o
	$(CC) $(LOPT) $(DRIVERS)/test.o $(CLFLAGS) -o test.ex

diff: $(LIB)
	$(CC) $(CFLAGS) -c $(DRIVERS)/HDEquation.c -o $(DRIVERS)/HDEquation.o
	$(CC) $(LOPT) $(DRIVERS)/HDEquation.o $(CLFLAGS) -o diff.ex
########################################################################
# Clean up
########################################################################

.PHONY : clean distclean help

clean:
	rm -f $(CSRCDIR)/assemble/*.o
	rm -f $(CSRCDIR)/fem/*.o
	rm -f $(CSRCDIR)/grid/*.o
	rm -f $(CSRCDIR)/solver/*.o
	rm -f $(CSRCDIR)/utilities/*.o
	rm -f drivers/*.o

distclean:
	make clean
	rm -f lib/*.a
	rm -f include/*~
	rm -f *~ *.ex *.out
	rm -f $(CSRCDIR)/assemble/*~
	rm -f $(CSRCDIR)/fem/*~
	rm -f $(CSRCDIR)/grid/*~
	rm -f $(CSRCDIR)/solver/*~
	rm -f $(CSRCDIR)/utilities/*~

help:
	@echo "======================================================"
	@echo " 		   HAZMAT		             "
	@echo "======================================================"
	@echo " "
	@echo " make            : build all exe files "
	@echo " make headers    : build the header file automatically"
	@echo " make lib        : build library "
	@echo " make test	: build test.ex "
	@echo " make clean      : clean all obj files "
	@echo " make distclean  : clean all obj, exe, bak, out files "
	@echo " make help       : show this screen "
	@echo " "

